generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum MealType {
  breakfast
  lunch
  dinner
  snack
}

enum CookingStyle {
  quick_weeknight
  batch_cook
  special_occasion
}

enum ApprovalStatus {
  pending
  approved
  rejected
  archived
}

enum IngredientCategory {
  staple
  perishable
  pantry
  produce
  meat
  dairy
  frozen
}

enum BrandPreference {
  preferred
  acceptable
  avoid
}

enum PantryStatus {
  stocked
  running_low
  depleted
}

enum PantrySource {
  grocery_trip
  manual_entry
  recipe_deduction
  user_checkin
}

enum MealPlanStatus {
  planned
  cooked
  skipped
}

enum ShoppingListStatus {
  draft
  ready
  shopping
  completed
}

enum UserOverride {
  need
  have
}

enum ReceiptStatus {
  uploaded
  parsed
  matched
  completed
}

enum CookingRating {
  thumbs_up
  thumbs_down
  neutral
}

enum CandidateStatus {
  pending
  approved
  rejected
  imported
  error
}

enum DayOfWeek {
  monday
  tuesday
  wednesday
  thursday
  friday
  saturday
  sunday
}

// Store / Agent enums

enum StoreProvider {
  ocado
}

enum PurchaseOrderStatus {
  pending
  approved
  placed
  delivered
  cancelled
}

enum PurchaseOrderSource {
  manual
  from_shopping_list
  from_receipt_import
}

enum StapleSource {
  user_confirmed
  auto_detected
  imported
}

enum ProductPreferenceStatus {
  unknown
  trying
  liked
  staple
  disliked
}

// Core Tables

model Recipe {
  id                         String         @id @default(uuid())
  name                       String
  description                String?
  source                     String?
  servings                   Int
  cookTimeMinutes            Int            @map("cook_time_minutes")
  prepTimeMinutes            Int?           @map("prep_time_minutes")
  totalTimeMinutes           Int?           @map("total_time_minutes")
  mealType                   MealType       @map("meal_type")
  cookingStyle               CookingStyle   @map("cooking_style")
  photoUrl                   String?        @map("photo_url")
  estimatedCaloriesPerServing Int?          @map("estimated_calories_per_serving")
  estimatedCostPerServing    Decimal?       @map("estimated_cost_per_serving") @db.Decimal(10, 2)
  caloriesIsEstimate         Boolean        @default(true) @map("calories_is_estimate")
  costIsEstimate             Boolean        @default(true) @map("cost_is_estimate")
  approvalStatus             ApprovalStatus @default(pending) @map("approval_status")
  timesCooked                Int            @default(0) @map("times_cooked")
  lastCookedDate             DateTime?      @map("last_cooked_date") @db.Date
  createdAt                  DateTime       @default(now()) @map("created_at")
  updatedAt                  DateTime       @updatedAt @map("updated_at")

  recipeIngredients RecipeIngredient[]
  recipeInstructions RecipeInstruction[]
  cookingHistory    CookingHistory[]
  mealPlans         MealPlan[]
  recipeCandidates  RecipeCandidate[]

  @@map("recipes")
}

model Ingredient {
  id                     String             @id @default(uuid())
  name                   String             @unique
  category               IngredientCategory
  typicalUnit            String             @map("typical_unit")
  estimatedCaloriesPerUnit Decimal?         @map("estimated_calories_per_unit") @db.Decimal(10, 2)
  estimatedCostPerUnit   Decimal?           @map("estimated_cost_per_unit") @db.Decimal(10, 2)
  imageUrl               String?            @map("image_url")
  createdAt              DateTime           @default(now()) @map("created_at")

  brands            Brand[]
  recipeIngredients RecipeIngredient[]
  pantryInventory   PantryInventory[]
  shoppingListItems ShoppingListItem[]
  ingredientStoreMappings IngredientStoreMapping[]
  shoppingListStoreOverrides ShoppingListIngredientStoreOverride[]
  purchaseOrderItems PurchaseOrderItem[]
  stapleRules        StapleRule[]
  storeProductPreferences StoreProductPreference[]

  @@map("ingredients")
}

model Brand {
  id              String          @id @default(uuid())
  ingredientId    String          @map("ingredient_id")
  brandName       String          @map("brand_name")
  preferenceLevel BrandPreference @map("preference_level")
  notes           String?
  createdAt       DateTime        @default(now()) @map("created_at")

  ingredient        Ingredient         @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  shoppingListItems ShoppingListItem[]

  @@map("brands")
}

model RecipeIngredient {
  id           String  @id @default(uuid())
  recipeId     String  @map("recipe_id")
  ingredientId String  @map("ingredient_id")
  quantity     Decimal @db.Decimal(10, 2)
  unit         String
  notes        String?
  optional     Boolean @default(false)
  createdAt    DateTime @default(now()) @map("created_at")

  recipe     Recipe     @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  ingredient Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)

  @@map("recipe_ingredients")
}

model RecipeInstruction {
  id              String   @id @default(uuid())
  recipeId        String   @map("recipe_id")
  stepNumber      Int      @map("step_number")
  instructionText String   @map("instruction_text")
  createdAt       DateTime @default(now()) @map("created_at")

  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@map("recipe_instructions")
}

model RecipeDiscoveryBatch {
  id             String   @id @default(uuid())
  query          String
  mealType       MealType?
  maxTimeMinutes Int?     @map("max_time_minutes")
  sources        String[]
  createdAt      DateTime @default(now()) @map("created_at")

  candidates RecipeCandidate[]

  @@map("recipe_discovery_batches")
}

model RecipeCandidate {
  id               String          @id @default(uuid())
  batchId          String          @map("batch_id")
  sourceUrl        String          @unique @map("source_url")
  sourceName       String          @map("source_name")
  name             String
  description      String?
  imageUrl         String?         @map("image_url")
  servings         Int?
  cookTimeMinutes  Int?            @map("cook_time_minutes")
  prepTimeMinutes  Int?            @map("prep_time_minutes")
  totalTimeMinutes Int?            @map("total_time_minutes")
  ingredients      String[]
  instructions     String[]
  status           CandidateStatus @default(pending)
  recipeId         String?         @map("recipe_id")
  errorMessage     String?         @map("error_message")
  createdAt        DateTime        @default(now()) @map("created_at")

  batch  RecipeDiscoveryBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  recipe Recipe?              @relation(fields: [recipeId], references: [id])

  @@map("recipe_candidates")
}

model DiscoverySource {
  id          String   @id @default(uuid())
  host        String   @unique
  displayName String?  @map("display_name")
  enabled     Boolean  @default(true)
  sitemapUrls String[] @map("sitemap_urls")
  rssUrls     String[] @map("rss_urls")
  weight      Int      @default(1)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("discovery_sources")
}

model CookingHistory {
  id                String        @id @default(uuid())
  recipeId          String        @map("recipe_id")
  cookedDate        DateTime      @map("cooked_date") @db.Date
  servingsMade      Int           @map("servings_made")
  isBatchCook       Boolean       @default(false) @map("is_batch_cook")
  intendedMealCount Int           @default(1) @map("intended_meal_count")
  rating            CookingRating?
  wouldMakeAgain    Boolean?      @map("would_make_again")
  notes             String?
  actualCost        Decimal?      @map("actual_cost") @db.Decimal(10, 2)
  actualTimeMinutes Int?          @map("actual_time_minutes")
  createdAt         DateTime      @default(now()) @map("created_at")

  recipe    Recipe     @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  mealPlans MealPlan[]

  @@map("cooking_history")
}

model PantryInventory {
  id             String       @id @default(uuid())
  ingredientId   String       @map("ingredient_id")
  quantity       Decimal      @db.Decimal(10, 2)
  unit           String
  acquiredDate   DateTime     @map("acquired_date") @db.Date
  expirationDate DateTime?    @map("expiration_date") @db.Date
  status         PantryStatus @default(stocked)
  source         PantrySource
  lastUpdated    DateTime     @default(now()) @updatedAt @map("last_updated")
  notes          String?

  ingredient Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)

  @@map("pantry_inventory")
}

model MealPlan {
  id                    String         @id @default(uuid())
  recipeId              String         @map("recipe_id")
  plannedDate           DateTime       @map("planned_date") @db.Date
  mealType              MealType       @map("meal_type")
  servingsPlanned       Int            @map("servings_planned")
  isLeftover            Boolean        @default(false) @map("is_leftover")
  parentCookingEventId  String?        @map("parent_cooking_event_id")
  status                MealPlanStatus @default(planned)
  createdAt             DateTime       @default(now()) @map("created_at")

  recipe             Recipe          @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  parentCookingEvent CookingHistory? @relation(fields: [parentCookingEventId], references: [id], onDelete: SetNull)

  @@map("meal_plans")
}

model ShoppingList {
  id                 String             @id @default(uuid())
  createdDate        DateTime           @default(now()) @map("created_date") @db.Date
  shoppingDate       DateTime?          @map("shopping_date") @db.Date
  status             ShoppingListStatus @default(draft)
  totalEstimatedCost Decimal?           @map("total_estimated_cost") @db.Decimal(10, 2)
  notes              String?
  createdAt          DateTime           @default(now()) @map("created_at")

  items ShoppingListItem[]
  storeOverrides ShoppingListIngredientStoreOverride[]
  purchaseOrders PurchaseOrder[]

  @@map("shopping_lists")
}

model ShoppingListItem {
  id             String       @id @default(uuid())
  shoppingListId String       @map("shopping_list_id")
  ingredientId   String       @map("ingredient_id")
  brandId        String?      @map("brand_id")
  quantity       Decimal      @db.Decimal(10, 2)
  unit           String
  assumedHave    Boolean      @default(false) @map("assumed_have")
  userOverride   UserOverride? @map("user_override")
  estimatedCost  Decimal?     @map("estimated_cost") @db.Decimal(10, 2)
  actualCost     Decimal?     @map("actual_cost") @db.Decimal(10, 2)
  purchased      Boolean      @default(false)
  recipeIds      String[]     @map("recipe_ids")
  notes          String?
  createdAt      DateTime     @default(now()) @map("created_at")

  shoppingList ShoppingList @relation(fields: [shoppingListId], references: [id], onDelete: Cascade)
  ingredient   Ingredient   @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  brand        Brand?       @relation(fields: [brandId], references: [id], onDelete: SetNull)

  @@map("shopping_list_items")
}

model GroceryReceipt {
  id               String        @id @default(uuid())
  storeName        String        @map("store_name")
  purchaseDate     DateTime      @map("purchase_date") @db.Date
  totalAmount      Decimal       @map("total_amount") @db.Decimal(10, 2)
  receiptImageUrl  String?       @map("receipt_image_url")
  parsedItems      Json?         @map("parsed_items")
  processingStatus ReceiptStatus @default(uploaded) @map("processing_status")
  createdAt        DateTime      @default(now()) @map("created_at")

  @@map("grocery_receipts")
}

model UserPreferences {
  id                  String    @id @default(uuid())
  budgetTargetWeekly  Decimal?  @map("budget_target_weekly") @db.Decimal(10, 2)
  calorieTargetDaily  Int?      @map("calorie_target_daily")
  preferredCuisines   String[]  @map("preferred_cuisines")
  dietaryRestrictions String[]  @map("dietary_restrictions")
  dislikedIngredients String[]  @map("disliked_ingredients")
  likedIngredients    String[]  @map("liked_ingredients")
  priorityWeights     Json?     @map("priority_weights")
  defaultShoppingDay  DayOfWeek? @map("default_shopping_day")
  measurementSystem   String    @default("us") @map("measurement_system")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@map("user_preferences")
}

model AppSecret {
  id             String   @id
  encryptedValue String   @map("encrypted_value")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("app_secrets")
}

// === Store Integrations / Ordering ===

model StoreIntegration {
  id                String        @id @default(uuid())
  provider          StoreProvider @unique
  displayName       String?       @map("display_name")
  enabled           Boolean       @default(true)
  defaultForOrdering Boolean      @default(false) @map("default_for_ordering")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  @@map("store_integrations")
}

model StoreProduct {
  id                String        @id @default(uuid())
  provider          StoreProvider
  providerProductId String        @map("provider_product_id")
  name              String
  brandName         String?       @map("brand_name")
  sizeText          String?       @map("size_text")
  imageUrl          String?       @map("image_url")
  productUrl        String?       @map("product_url")
  lastSeenPrice     Decimal?      @map("last_seen_price") @db.Decimal(10, 2)
  currency          String?       @default("GBP")
  lastSeenAt        DateTime?     @map("last_seen_at")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  ingredientMappings IngredientStoreMapping[]
  shoppingListOverrides ShoppingListIngredientStoreOverride[]
  orderItems         PurchaseOrderItem[]
  preferences        StoreProductPreference[]
  stapleRules        StapleRule[]

  @@unique([provider, providerProductId])
  @@map("store_products")
}

model IngredientStoreMapping {
  id              String      @id @default(uuid())
  ingredientId    String      @map("ingredient_id")
  storeProductId  String      @map("store_product_id")
  isDefault       Boolean     @default(true) @map("is_default")
  confidence      Decimal     @default(1.0) @db.Decimal(3, 2)
  lastConfirmedAt DateTime?   @map("last_confirmed_at")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  ingredient   Ingredient   @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  storeProduct StoreProduct @relation(fields: [storeProductId], references: [id], onDelete: Cascade)

  @@unique([ingredientId, storeProductId])
  @@map("ingredient_store_mappings")
}

// Per-shopping-list overrides: select a product for this list without changing the global default mapping.
model ShoppingListIngredientStoreOverride {
  id             String        @id @default(uuid())
  shoppingListId String        @map("shopping_list_id")
  ingredientId   String        @map("ingredient_id")
  provider       StoreProvider
  storeProductId String        @map("store_product_id")
  lastConfirmedAt DateTime?    @map("last_confirmed_at")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  shoppingList ShoppingList @relation(fields: [shoppingListId], references: [id], onDelete: Cascade)
  ingredient   Ingredient   @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  storeProduct StoreProduct @relation(fields: [storeProductId], references: [id], onDelete: Cascade)

  @@unique([shoppingListId, ingredientId, provider])
  @@map("shopping_list_ingredient_store_overrides")
}

// === Purchase history (for budget + staples) ===

model PurchaseOrder {
  id            String             @id @default(uuid())
  provider      StoreProvider
  // Timestamp semantics:
  // - createdAt: when we recorded the order object (snapshot/workflow)
  // - approvedAt: when checkout dry-run / slot selection completed
  // - placedAt: when user confirmed placement (or automation placed a real order)
  // - deliveredAt: when delivery was confirmed (manual or import)
  // - cancelledAt: when cancelled (terminal)
  approvedAt    DateTime?          @map("approved_at")
  placedAt      DateTime?          @map("placed_at")
  deliveredAt   DateTime?          @map("delivered_at")
  cancelledAt   DateTime?          @map("cancelled_at")
  total         Decimal            @db.Decimal(10, 2)
  currency      String             @default("GBP")
  status        PurchaseOrderStatus @default(pending)
  source        PurchaseOrderSource @default(manual)
  shoppingListId String?           @map("shopping_list_id")
  deliverySlot  String?            @map("delivery_slot")
  checkoutUrl   String?            @map("checkout_url")
  notes         String?
  createdAt     DateTime           @default(now()) @map("created_at")
  updatedAt     DateTime           @updatedAt @map("updated_at")

  shoppingList ShoppingList? @relation(fields: [shoppingListId], references: [id], onDelete: SetNull)
  items        PurchaseOrderItem[]

  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id             String   @id @default(uuid())
  purchaseOrderId String  @map("purchase_order_id")
  ingredientId   String?  @map("ingredient_id")
  storeProductId String?  @map("store_product_id")
  rawName        String   @map("raw_name")
  quantity       Int      @default(1)
  unit           String?
  price          Decimal  @db.Decimal(10, 2)
  lineTotal      Decimal? @map("line_total") @db.Decimal(10, 2)
  createdAt      DateTime @default(now()) @map("created_at")

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  ingredient    Ingredient?   @relation(fields: [ingredientId], references: [id], onDelete: SetNull)
  storeProduct  StoreProduct? @relation(fields: [storeProductId], references: [id], onDelete: SetNull)

  @@map("purchase_order_items")
}

// === Staples and preferences ===

model StapleRule {
  id              String       @id @default(uuid())
  ingredientId    String?      @map("ingredient_id")
  storeProductId  String?      @map("store_product_id")
  normalizedName  String?      @map("normalized_name")
  reorderAfterDays Int         @default(7) @map("reorder_after_days")
  enabled         Boolean      @default(false)
  confidence      Decimal      @default(0.5) @db.Decimal(3, 2)
  source          StapleSource @default(auto_detected)
  lastPurchasedAt DateTime?    @map("last_purchased_at")
  lastSuggestedAt DateTime?    @map("last_suggested_at")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  ingredient   Ingredient?   @relation(fields: [ingredientId], references: [id], onDelete: SetNull)
  storeProduct StoreProduct? @relation(fields: [storeProductId], references: [id], onDelete: SetNull)

  @@map("staple_rules")
}

model StoreProductPreference {
  id             String                  @id @default(uuid())
  storeProductId String?                 @map("store_product_id")
  ingredientId   String?                 @map("ingredient_id")
  normalizedName String                  @map("normalized_name")
  status         ProductPreferenceStatus @default(unknown)
  typicalPrice   Decimal?                @map("typical_price") @db.Decimal(10, 2)
  notes          String?
  lastPurchasedAt DateTime?              @map("last_purchased_at")
  purchaseCount  Int                     @default(0) @map("purchase_count")
  createdAt      DateTime                @default(now()) @map("created_at")
  updatedAt      DateTime                @updatedAt @map("updated_at")

  storeProduct StoreProduct? @relation(fields: [storeProductId], references: [id], onDelete: SetNull)
  ingredient   Ingredient?   @relation(fields: [ingredientId], references: [id], onDelete: SetNull)

  @@map("store_product_preferences")
}

// Minimal assistant session persistence (for Telegram chat + web)
model AssistantSession {
  id         String   @id @default(uuid())
  channel    String   // 'telegram' | 'web'
  externalId String   @map("external_id") // telegram chat id or web session id
  state      Json?    // conversation state/tool results summaries
  updatedAt  DateTime @updatedAt @map("updated_at")
  createdAt  DateTime @default(now()) @map("created_at")

  @@unique([channel, externalId])
  @@map("assistant_sessions")
}
